<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy List - MY & SG</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        label { font-weight: bold; }
        select, button { padding: 8px; margin-right: 10px; font-size: 16px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .error { color: red; }
        .success { color: green; }
        .checking { color: #666; }
        .last-updated { color: #666; font-size: 14px; margin-bottom: 10px; }
        @media (max-width: 600px) {
            table { 
                display: block; 
                overflow-x: auto; 
                white-space: nowrap; 
            }
            th, td { 
                font-size: 14px; 
                padding: 8px; 
            }
            select, button { 
                font-size: 14px; 
                padding: 6px; 
                margin-right: 5px; 
            }
            h1 { font-size: 20px; }
            label { font-size: 14px; }
            .last-updated { font-size: 12px; }
        }
    </style>
</head>
<body>
    <h1>Proxy List</h1>
    <div>
        <label for="countrySelect">Select Country:</label>
        <select id="countrySelect">
            <option value="">Loading...</option>
        </select>
        <button onclick="refreshProxies()">Refresh Now</button>
        <div id="lastUpdated" class="last-updated"></div>
    </div>
    <table id="proxyTable">
        <thead>
            <tr>
                <th>IP</th>
                <th>Port</th>
                <th>Country</th>
                <th>Provider</th>
                <th>Status (ms)</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5">Loading proxies...</td></tr>
        </tbody>
    </table>

    <script>
        let allProxies = [];
        let currentSelection = 'MY-SG';

        async function fetchProxies() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/FoolVPN-ID/Nautica/refs/heads/main/proxyList.txt');
                if (!response.ok) throw new Error('Fetch failed');
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('-'));
                const proxies = lines.map(line => {
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                        return {
                            ip: parts[0].trim(),
                            port: parts[1].trim(),
                            country: parts[2].trim(),
                            provider: parts[3].trim(),
                            status: 'Checking...' // Initial status
                        };
                    }
                    return null;
                }).filter(p => p !== null);
                return proxies;
            } catch (error) {
                console.error('Fetch error:', error);
                document.querySelector('#proxyTable tbody').innerHTML = '<tr><td colspan="5" class="error">Error loading proxies. Please try refreshing.</td></tr>';
                return [];
            }
        }

        async function checkProxy(proxy) {
            try {
                const response = await fetch(`https://check.proxyip.cmliussss.net/check?proxyip=${proxy.ip}:${proxy.port}`);
                if (!response.ok) throw new Error('API check failed');
                const data = await response.json();
                return {
                    status: data.success ? `Working: ${data.responseTime}ms` : `Failed: ${data.message || 'Unknown error'}`,
                    className: data.success ? 'success' : 'error'
                };
            } catch (error) {
                console.error(`Check failed for ${proxy.ip}:${proxy.port}:`, error);
                return { status: 'Failed: Network error', className: 'error' };
            }
        }

        function populateDropdown(countries) {
            const select = document.getElementById('countrySelect');
            select.innerHTML = '';

            const defaultOpt = document.createElement('option');
            defaultOpt.value = 'MY-SG';
            defaultOpt.textContent = 'MY & SG (Default)';
            defaultOpt.selected = true;
            select.appendChild(defaultOpt);

            const otherCountries = countries.filter(c => c !== 'MY' && c !== 'SG').sort();
            otherCountries.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code;
                select.appendChild(opt);
            });

            ['MY', 'SG'].forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code;
                select.appendChild(opt);
            });

            select.onchange = handleSelectionChange;
        }

        function handleSelectionChange(event) {
            currentSelection = event.target.value;
            displayProxies();
        }

        async function displayProxies() {
            const tbody = document.querySelector('#proxyTable tbody');
            let proxiesToShow = [];

            if (currentSelection === 'MY-SG') {
                proxiesToShow = allProxies.filter(p => p.country === 'MY' || p.country === 'SG');
            } else {
                proxiesToShow = allProxies.filter(p => p.country === currentSelection);
            }

            tbody.innerHTML = '';
            if (proxiesToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No proxies available for this selection.</td></tr>';
                return;
            }

            // Set initial "Checking..." status
            proxiesToShow.forEach(proxy => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${proxy.ip}</td>
                    <td>${proxy.port}</td>
                    <td>${proxy.country}</td>
                    <td>${proxy.provider}</td>
                    <td class="checking">${proxy.status}</td>
                `;
                tbody.appendChild(row);
            });

            // Check proxies in parallel
            const checkPromises = proxiesToShow.map(async (proxy, index) => {
                const result = await checkProxy(proxy);
                proxy.status = result.status;
                proxy.statusClass = result.className;
                // Update the specific row
                const rows = tbody.querySelectorAll('tr');
                if (rows[index]) {
                    rows[index].querySelector('td:last-child').textContent = proxy.status;
                    rows[index].querySelector('td:last-child').className = proxy.statusClass;
                }
            });

            await Promise.all(checkPromises);

            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;
        }

        async function loadProxies() {
            allProxies = await fetchProxies();
            if (allProxies.length > 0) {
                const countries = [...new Set(allProxies.map(p => p.country))];
                populateDropdown(countries);
                await displayProxies();
            }
        }

        function refreshProxies() {
            loadProxies();
        }

        loadProxies();
        setInterval(refreshProxies, 3600000);
    </script>
</body>
</html>
